<!doctype html>
<html lang="en-us">
  <head>
    <title>Heroku log drains into Logstash // Joe Miller</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.55.6" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Joe Miller" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="http://joemiller.me/css/main.min.f1dfd0c62a48c2c4333e0fd932119a5f3d0e9e50b6eb85e8abf4fa9952e7df51.css" />

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-17214890-1', 'auto');
	
	ga('send', 'pageview');
}
</script>

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Heroku log drains into Logstash"/>
<meta name="twitter:description" content="The first and obvious option for shipping logs from a heroku app to Logstash is the heroku input plugin. However, this requires installing the Heroku gem and deploying the login &#43; password of a Heroku user to your Logstash server(s). At this time it seems that any user given permissions to an app on Heroku has full control. Not good when you just want to fetch logs. Heroku has added more granular permissions via OAuth but the Heroku gem does not support OAuth tokens yet.

Fortunately there&rsquo;s another option using Heroku&rsquo;s log drain. Setting up a log drain from Heroku to Logstash is almost as simple as the Heroku input plugin but has the major advantage of not requiring any new users or passwords to be deployed on the Logstash server."/>

    <meta property="og:title" content="Heroku log drains into Logstash" />
<meta property="og:description" content="The first and obvious option for shipping logs from a heroku app to Logstash is the heroku input plugin. However, this requires installing the Heroku gem and deploying the login &#43; password of a Heroku user to your Logstash server(s). At this time it seems that any user given permissions to an app on Heroku has full control. Not good when you just want to fetch logs. Heroku has added more granular permissions via OAuth but the Heroku gem does not support OAuth tokens yet.

Fortunately there&rsquo;s another option using Heroku&rsquo;s log drain. Setting up a log drain from Heroku to Logstash is almost as simple as the Heroku input plugin but has the major advantage of not requiring any new users or passwords to be deployed on the Logstash server." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://joemiller.me/2014/01/heroku-log-drains-into-logstash/" />
<meta property="article:published_time" content="2014-01-31T11:45:58-08:00"/>
<meta property="article:modified_time" content="2014-01-31T11:45:58-08:00"/>


  </head>
  <body>
    <header class="app-header">
      <a href="http://joemiller.me"><img class="app-header-avatar" src="/avatar.jpg" alt="Joe Miller" /></a>
      <h1>Joe Miller</h1>
      <p>Infrastructure Ops/Engineering. Continuously DevOping at Webscale</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/joemiller"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://twitter.com/miller_joe"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
        
          <a target="_blank" href="https://keybase.io/joemiller"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-key">
  <title>key</title>
  <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
</svg></a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Heroku log drains into Logstash</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jan 31, 2014
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          3 min read
        </div><div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-tag">
  <title>tag</title>
  <path d="M20.59 13.41l-7.17 7.17a2 2 0 0 1-2.83 0L2 12V2h10l8.59 8.59a2 2 0 0 1 0 2.82z"></path><line x1="7" y1="7" x2="7" y2="7"></line>
</svg>
          <a class="tag" href="http://joemiller.me/tags/linux/">linux</a><a class="tag" href="http://joemiller.me/tags/monitoring/">monitoring</a><a class="tag" href="http://joemiller.me/tags/logging/">logging</a><a class="tag" href="http://joemiller.me/tags/heroku/">heroku</a><a class="tag" href="http://joemiller.me/tags/logstash/">logstash</a></div></div>
    </header>
    <nav id="toc">
      <nav id="TableOfContents">
<ul>
<li><a href="#install-heroku-toolbelt">Install Heroku toolbelt</a></li>
<li><a href="#configure-log-drain">Configure log drain</a></li>
<li><a href="#configure-logstash">Configure Logstash</a></li>
</ul>
</nav>
    </nav>
    <div class="post-content">
      <p>The first and obvious option for shipping logs from a heroku app to Logstash is the <a href="http://logstash.net/docs/1.3.3/inputs/heroku">heroku input plugin</a>. However, this requires installing the Heroku gem and deploying the login + password of a Heroku user to your Logstash server(s). At this time it seems that any user given permissions to an app on Heroku has full control. Not good when you just want to fetch logs. Heroku has added more granular permissions via OAuth but the Heroku gem does not support OAuth tokens yet.</p>

<p>Fortunately there&rsquo;s another option using Heroku&rsquo;s log drain. Setting up a log drain from Heroku to Logstash is almost as simple as the Heroku input plugin but has the major advantage of not requiring any new users or passwords to be deployed on the Logstash server.</p>

<p>Hooking up your Heroku-deployed apps to your Logstash/Kibana/Elasticsearch infrastructure is straightforward using the syslog drains provided by Heroku. Here is a recipe for putting the pieces together:</p>

<h1 id="install-heroku-toolbelt">Install Heroku toolbelt</h1>

<p>In order to configure a log drain on Heroku you need to install the Heroku toolbelt (or using the API directly). At this time I don&rsquo;t think there&rsquo;s a way to configure log drains from the web UI.</p>

<p>The heroku toolbelt can also be used to tail an apps&rsquo; logs on the command line which is great for debugging since the logs output by this command are identical to the logs that should be sent to the Logstash if everything is configured correctly:</p>

<p>List apps:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ heroku apps

myapp1 email@dom.tld
myapp2 email@dom.tld</code></pre></div>

<p>Tail app&rsquo;s logs:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ heroku logs --app myapp1 -t

2014-01-31T14:26:11.801629+00:00 app[web.1]: 2014-01-31T14:26:11.801Z - debug: FETCHING TICKET: 15846
2014-01-31T14:26:26.753977+00:00 app[web.1]: 2014-01-31T14:26:26.752Z - debug: FETCHING TICKET: 15851
2014-01-31T14:26:27.457415+00:00 heroku[router]: at=info method=GET path=/ping? host=myapp1 request_id=6cb9b9eb-388c-4364-9278-a81179067f21 fwd=&#34;50.57.38.1&#34; dyno=web.2 connect=7ms service=6ms status=200 bytes=2</code></pre></div>

<h1 id="configure-log-drain">Configure log drain</h1>

<p>Use the Heroku toolbelt to configure a log drain:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ heroku drains:add --app myapp1 syslog://logstash.dom.tld:1514</code></pre></div>

<p>Heroku&rsquo;s Logplex system will now send all logs generated from <code>myapp1</code> to <code>logstash.dom.tld:1514</code> via TCP in syslog RFC-5424 format.</p>

<h1 id="configure-logstash">Configure Logstash</h1>

<p>Next, configure a Logstash input to receive these logs:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">input {
    tcp {
        port =&gt; &#34;1514&#34;
        tags =&gt; [&#34;input_heroku_syslog&#34;]
    }
}</code></pre></div>

<p>Heroku uses the syslog format as defined in RFC 5424. Logstash ships with a grok rules that parse out most syslog formats including RFC 5424 but I found that they were not quite perfect for Heroku logs.</p>

<p>For more details on Heroku log drains: <a href="https://devcenter.heroku.com/articles/logging">https://devcenter.heroku.com/articles/logging</a></p>

<p>Here are examples of raw log lines sent by Heroku. These are exactly what Logstash will receive and suitable for testing with the <a href="http://grokdebug.herokuapp.com/">grok debugger</a>.</p>

<p>The first is an example of a log message sent from a heroku component, in this case the Heroku router:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">231 1 2014-01-08T01:05:27.967180+00:00 d.9bc44987-ff40-40ac-a248-ff4ec4d71d7c heroku router - - at=info method=POST path=/ host=myapp1.herokuapp.com fwd=&#34;204.236.185.9&#34; dyno=web.1 connect=2ms service=81ms status=200 bytes=2</code></pre></div>

<p>Next, is an example of a log line generated from the application&rsquo;s stdout:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">158 1 2014-01-08T17:49:14.822585+00:00 d.9bc44987-ff40-40ac-a248-ff4ec4d71d7c app web.1 - - 2014-01-08T17:49:14.822Z -minfo: FETCHING TICKET: 15103</code></pre></div>

<p>Here is the grok pattern we use to parse Heroku&rsquo;s syslog RFC 5424-(ish) log messages:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">filter {
  if &#34;input_heroku_syslog&#34; in [tags] {
    grok {
      match =&gt; [&#34;message&#34;, &#34;%{SYSLOG5424PRI}%{NONNEGINT:syslog5424_ver} +(?:%{TIMESTAMP_ISO8601:timestamp}|-) +(?:%{HOSTNAME:heroku_drain_id}|-) +(?:%{WORD:heroku_source}|-) +(?:%{DATA:heroku_dyno}|-) +(?:%{WORD:syslog5424_msgid}|-) +(?:%{SYSLOG5424SD:syslog5424_sd}|-|) +%{GREEDYDATA:heroku_message}&#34;]
    }
    mutate { rename =&gt; [&#34;heroku_message&#34;, &#34;message&#34;] }
    kv { source =&gt; &#34;message&#34; }
    syslog_pri { syslog_pri_field_name =&gt; &#34;syslog5424_pri&#34; }
  }
}</code></pre></div>

<p>A few notes about this filter config:</p>

<ul>
<li>The log message will be stored in the <code>message</code> field.</li>
<li>Key/value pairs matching <code>key=value</code> in the <code>message</code> will be parsed and added to the Logstash event. Many of the internal Heroku components&rsquo;s logs include useful key/vals.</li>
<li>Special fields <code>heroku_drain_id</code>, <code>heroku_source</code>, and <code>heroku_dyno</code> will be extracted from each event.</li>
</ul>
    </div>
    <div class="post-footer">
      
      This post was published <strong>1997</strong> days ago, content in the post may be inaccurate, even wrong now.
    </div>
  </article>

    </main>
  </body>
</html>
