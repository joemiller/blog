<!doctype html>
<html lang="en-us">
  <head>
    <title>Sensu and Graphite, Part 2 // Joe Miller</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.55.6" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Joe Miller" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="http://joemiller.me/css/main.min.ca1c5a29e06d10e8d8a238b0807c8594a9a6a5697064715b007b4425e9baaca1.css" />

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Sensu and Graphite, Part 2"/>
<meta name="twitter:description" content="In a previous post I described two methods for routing metrics generated by Sensu clients to Graphite:


use a pipe handler to send metrics via TCP to graphite
use Graphite&rsquo;s AMQP (rabbitmq) support.


Method #1 was simply described for completeness. It is not scalable and shouldn&rsquo;t be used except for very small workloads. Pipe handlers involve a fork() by sensu-server for every metric received.

At the time I recommended method #2 which was more efficient - Sensu would simply copy the metric from its own results queue to another queue that Graphite would be listening on, since both Sensu and Graphite can talk to RabbitMQ."/>

    <meta property="og:title" content="Sensu and Graphite, Part 2" />
<meta property="og:description" content="In a previous post I described two methods for routing metrics generated by Sensu clients to Graphite:


use a pipe handler to send metrics via TCP to graphite
use Graphite&rsquo;s AMQP (rabbitmq) support.


Method #1 was simply described for completeness. It is not scalable and shouldn&rsquo;t be used except for very small workloads. Pipe handlers involve a fork() by sensu-server for every metric received.

At the time I recommended method #2 which was more efficient - Sensu would simply copy the metric from its own results queue to another queue that Graphite would be listening on, since both Sensu and Graphite can talk to RabbitMQ." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://joemiller.me/2013/12/07/sensu-and-graphite-part-2/" />
<meta property="article:published_time" content="2013-12-07T18:55:11-08:00"/>
<meta property="article:modified_time" content="2013-12-07T18:55:11-08:00"/>


  </head>
  <body>
    <header class="app-header">
      <a href="http://joemiller.me"><img class="app-header-avatar" src="/avatar.jpg" alt="Joe Miller" /></a>
      <h1>Joe Miller</h1>
      <p>Infrastructure Ops/Engineering. Continuously DevOping at Webscale</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/joemiller"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://twitter.com/miller_joe"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
        
          <a target="_blank" href="https://keybase.io/joemiller"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-key">
  <title>key</title>
  <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
</svg></a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Sensu and Graphite, Part 2</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Dec 7, 2013
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          4 min read
        </div></div>
    </header>
    <nav id="toc">
      <nav id="TableOfContents">
<ul>
<li>
<ul>
<li>
<ul>
<li><a href="#newer-better-ways">Newer, better ways</a></li>
<li><a href="#sensu-server-tcp-handler">Sensu-server TCP Handler</a></li>
<li><a href="#wizardvan-aka-sensu-metrics-relay-extension">WizardVan (aka, sensu-metrics-relay) Extension</a></li>
</ul></li>
</ul></li>
</ul>
</nav>
    </nav>
    <div class="post-content">
      <p>In a <a href="http://joemiller.me/2012/02/02/sensu-and-graphite/">previous post</a> I described two methods for routing metrics generated by Sensu clients to Graphite:</p>

<ul>
<li>use a <code>pipe</code> handler to send metrics via TCP to graphite</li>
<li>use Graphite&rsquo;s AMQP (rabbitmq) support.</li>
</ul>

<p>Method #1 was simply described for completeness. It is not scalable and shouldn&rsquo;t be used except for very small workloads. Pipe handlers involve a fork() by sensu-server for every metric received.</p>

<p>At the time I recommended method #2 which was more efficient - Sensu would simply copy the metric from its own <code>results</code> queue to another queue that Graphite would be listening on, since both Sensu and Graphite can talk to RabbitMQ.</p>

<p>However, Graphite&rsquo;s AMQP support is fairly lacking, in my opinion. It does not seem to be getting much attention on the regular Graphite support forums and the code around AMQP has not changed much. The docs section describing its configuration remains an empty TODO.</p>

<p>The main reason I don&rsquo;t like the AMQP approach anymore is that it does not work well with Graphite clusters. I prefer to build a Graphite cluster where each node is identically configured. Each node would connect to a an AMQP queue, pop a metric off of the queue in a load-balanced fashion, then let carbon-relay&rsquo;s routing rules figure out where to send the metric. It does not work this way. Instead each graphite node would pull each metric posted to the queue, duplicating effort on each node in the cluster. This is wasteful and limits the capacity of the cluster needlessly.</p>

<h3 id="newer-better-ways">Newer, better ways</h3>

<p>My new preferred method for sending metrics to Graphite is to use TCP with a load-balancer in front of Graphite&rsquo;s carbon-relay instances in the case of a multi-node cluster.</p>

<p>This was not really possible when the initial blog post was written, but since that time Sensu has added support for <code>extensions</code> handlers in addition to the original <code>pipe</code> handlers. Extensions are Ruby code that is loaded and run inside the sensu-server process. They are much more efficient than fork()&lsquo;ing to handle each event.</p>

<p>There are two extension handlers available for sending metrics to Graphite:</p>

<ul>
<li>Sensu-server TCP handler: Ships with sensu-server. Very simple, takes the <code>event['output']</code> string and sends it untouched over a TCP socket to a destination.</li>
<li><a href="https://twitter.com/grepory">@grepory&rsquo;s</a> <a href="https://github.com/opower/sensu-metrics-relay">WizardVan</a>: More features, supports OpenTSDB and Graphite, buffering support, re-connect, backoff, etc.</li>
</ul>

<p>Here is a quick example of configuring each of these extension handlers.</p>

<h3 id="sensu-server-tcp-handler">Sensu-server TCP Handler</h3>

<p>Configuring the TCP handler that ships with Sensu is easy and is documented in the <a href="http://sensuapp.org/docs/0.12/handlers">handlers</a> section of the Sensu docs.</p>

<p>The TCP handler is very basic and will simply copy the output of the check directly over the socket. This works out fine for most Sensu metric checks since the defacto standard for most is to output graphite&rsquo;s line-oriented format.</p>

<p>Example tcp handler:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><code class="language-js" data-lang="js"><span></span><span style="color: #f8f8f2">{</span>
  <span style="color: #e6db74">&quot;handlers&quot;</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #e6db74">&quot;graphite_line_tcp&quot;</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #e6db74">&quot;type&quot;</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&quot;tcp&quot;</span><span style="color: #f8f8f2">,</span>
      <span style="color: #e6db74">&quot;socket&quot;</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #e6db74">&quot;host&quot;</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&quot;metrics.dom.tld&quot;</span><span style="color: #f8f8f2">,</span>
        <span style="color: #e6db74">&quot;port&quot;</span><span style="color: #f92672">:</span> <span style="color: #ae81ff">2003</span>
      <span style="color: #f8f8f2">}</span>
    <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
</code></pre></div>


<p>Add the <code>graphite_line_tcp</code> handler to your metric checks:</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><code class="language-js" data-lang="js"><span></span><span style="color: #f8f8f2">{</span>
  <span style="color: #e6db74">&quot;checks&quot;</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #e6db74">&quot;vmstat_metrics&quot;</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
      <span style="color: #e6db74">&quot;type&quot;</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&quot;metric&quot;</span><span style="color: #f8f8f2">,</span>
      <span style="color: #e6db74">&quot;handlers&quot;</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&quot;graphite_line_tcp&quot;</span><span style="color: #f8f8f2">],</span>
      <span style="color: #e6db74">&quot;command&quot;</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&quot;/etc/sensu/plugins/vmstat-metrics.rb --scheme stats.:::name:::&quot;</span><span style="color: #f8f8f2">,</span>
      <span style="color: #e6db74">&quot;interval&quot;</span><span style="color: #f92672">:</span> <span style="color: #ae81ff">60</span><span style="color: #f8f8f2">,</span>
      <span style="color: #e6db74">&quot;subscribers&quot;</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">[</span><span style="color: #e6db74">&quot;webservers&quot;</span><span style="color: #f8f8f2">]</span>
    <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
</code></pre></div>


<h3 id="wizardvan-aka-sensu-metrics-relay-extension">WizardVan (aka, sensu-metrics-relay) Extension</h3>

<p>A more advanced TCP extension handler is available from <a href="https://twitter.com/grepory">@grepory</a> and goes by the code-name <a href="https://github.com/opower/sensu-metrics-relay">WizardVan</a> or <a href="https://github.com/opower/sensu-metrics-relay">sensu-metrics-relay</a> (same thing, but I was confused for a moment).</p>

<p>WizardVan does not come shipped with Sensu but <a href="https://github.com/opower/sensu-metrics-relay#installation">installation instructions</a> are available on its Github page. In the future it may be easier to install by shipping as a rubygem.</p>

<p>WizardVan also takes advantage of another newer Sensu feature known as <a href="http://sensuapp.org/docs/0.12/mutators">mutators</a> which provide the ability for WizardVan to send metrics to either Graphite or OpenTSDB or both.</p>

<p>By default, WizardVan assumes that metrics are in Graphite format and so configuring it for use with Graphite is straight-forward:</p>

<p>Here is a general example for configuring WizardVan. See the docs for more options.</p>

<div class="highlight" style="background: #272822"><pre style="line-height: 125%"><code class="language-js" data-lang="js"><span></span><span style="color: #f8f8f2">{</span>
  <span style="color: #e6db74">&quot;handlers&quot;</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
    <span style="color: #e6db74">&quot;relay&quot;</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
        <span style="color: #e6db74">&quot;graphite&quot;</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #e6db74">&quot;host&quot;</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&quot;graphite.dom.tld&quot;</span><span style="color: #f8f8f2">,</span>
            <span style="color: #e6db74">&quot;port&quot;</span><span style="color: #f92672">:</span> <span style="color: #ae81ff">2003</span>
        <span style="color: #f8f8f2">},</span>
        <span style="color: #e6db74">&quot;opentsdb&quot;</span><span style="color: #f92672">:</span> <span style="color: #f8f8f2">{</span>
            <span style="color: #e6db74">&quot;host&quot;</span><span style="color: #f92672">:</span> <span style="color: #e6db74">&quot;tsdb.dom.tld&quot;</span><span style="color: #f8f8f2">,</span>
            <span style="color: #e6db74">&quot;port&quot;</span><span style="color: #f92672">:</span> <span style="color: #ae81ff">4424</span>
        <span style="color: #f8f8f2">}</span>
    <span style="color: #f8f8f2">}</span>
  <span style="color: #f8f8f2">}</span>
<span style="color: #f8f8f2">}</span>
</code></pre></div>


<p>For further information on configuring WizardVan see the <a href="https://github.com/opower/sensu-metrics-relay">README</a>.</p>

<p>NOTE: Unless you have a very high (hundreds/sec) rate of metrics you may need to lower WizardVan&rsquo;s <a href="https://github.com/opower/sensu-metrics-relay/blob/master/lib/sensu/extensions/handlers/relay.rb#L117">MAX_QUEUE_SUZE</a> to something less than 16KB (try 128). Hopefully soon this will be configurable instead of hardcoded.</p>
    </div>
    <div class="post-footer">
      
      This post was published <strong>2051</strong> days ago, content in the post may be inaccurate, even wrong now.
    </div>
  </article>

    </main>
  </body>
</html>
