<!doctype html>
<html lang="en-us">
  <head>
    <title>Sign releases with a project GPG key // Joe Miller</title>
    <meta charset="utf-8" />
    <meta name="generator" content="Hugo 0.55.6" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="author" content="Joe Miller" />
    <meta name="description" content="" />
    <link rel="stylesheet" href="http://joemiller.me/css/main.min.f1dfd0c62a48c2c4333e0fd932119a5f3d0e9e50b6eb85e8abf4fa9952e7df51.css" />

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-XXXXXXXX-X', 'auto');
	
	ga('send', 'pageview');
}
</script>

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Sign releases with a project GPG key"/>
<meta name="twitter:description" content="Intro TODO: intro, rationale, link to the stackoverflow article that sparked the idea
Create the project master GPG key This guide assumes you have already created a personal GPG key. This is referred to as an &ldquo;author key&rdquo; in this guide and will be used to sign the project key, verifying your relationship to the project.
List current secret keys (-K /--list-secret-keys):
$ gpg --keyid-format long -K /Users/joe/.gnupg/pubring.kbx ----------------------------- sec rsa4096/ADC517A11EB0B309 2016-02-09 [SC] Key fingerprint = CF5C 5827 E7BD 7059 7992 8EC4 ADC5 17A1 1EB0 B309 uid [ultimate] Joe Miller &lt;joemiller@keybase."/>

    <meta property="og:title" content="Sign releases with a project GPG key" />
<meta property="og:description" content="Intro TODO: intro, rationale, link to the stackoverflow article that sparked the idea
Create the project master GPG key This guide assumes you have already created a personal GPG key. This is referred to as an &ldquo;author key&rdquo; in this guide and will be used to sign the project key, verifying your relationship to the project.
List current secret keys (-K /--list-secret-keys):
$ gpg --keyid-format long -K /Users/joe/.gnupg/pubring.kbx ----------------------------- sec rsa4096/ADC517A11EB0B309 2016-02-09 [SC] Key fingerprint = CF5C 5827 E7BD 7059 7992 8EC4 ADC5 17A1 1EB0 B309 uid [ultimate] Joe Miller &lt;joemiller@keybase." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://joemiller.me/2019/07/sign-releases-with-a-project-gpg-key/" />
<meta property="article:published_time" content="2019-07-20T07:50:48-07:00"/>
<meta property="article:modified_time" content="2019-07-20T07:50:48-07:00"/>


  </head>
  <body>
    <header class="app-header">
      <a href="http://joemiller.me"><img class="app-header-avatar" src="/avatar.jpg" alt="Joe Miller" /></a>
      <h1>Joe Miller</h1>
      <p>Infrastructure Ops/Engineering. Continuously DevOping at Webscale</p>
      <div class="app-header-social">
        
          <a target="_blank" href="https://github.com/joemiller"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-github">
  <title>github</title>
  <path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37 0 0 0-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44 0 0 0 20 4.77 5.07 5.07 0 0 0 19.91 1S18.73.65 16 2.48a13.38 13.38 0 0 0-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07 0 0 0 5 4.77a5.44 5.44 0 0 0-1.5 3.78c0 5.42 3.3 6.61 6.44 7A3.37 3.37 0 0 0 9 18.13V22"></path>
</svg></a>
        
          <a target="_blank" href="https://twitter.com/miller_joe"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-twitter">
  <title>twitter</title>
  <path d="M23 3a10.9 10.9 0 0 1-3.14 1.53 4.48 4.48 0 0 0-7.86 3v1A10.66 10.66 0 0 1 3 4s-4 9 5 13a11.64 11.64 0 0 1-7 2c9 5 20 0 20-11.5a4.5 4.5 0 0 0-.08-.83A7.72 7.72 0 0 0 23 3z"></path>
</svg></a>
        
          <a target="_blank" href="https://keybase.io/joemiller"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-key">
  <title>key</title>
  <path d="M21 2l-2 2m-7.61 7.61a5.5 5.5 0 1 1-7.778 7.778 5.5 5.5 0 0 1 7.777-7.777zm0 0L15.5 7.5m0 0l3 3L22 7l-3-3m-3.5 3.5L19 4"></path>
</svg></a>
        
      </div>
    </header>
    <main class="app-container">
      
  <article class="post">
    <header class="post-header">
      <h1 class ="post-title">Sign releases with a project GPG key</h1>
      <div class="post-meta">
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-calendar">
  <title>calendar</title>
  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line>
</svg>
          Jul 20, 2019
        </div>
        <div>
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="icon icon-clock">
  <title>clock</title>
  <circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline>
</svg>
          7 min read
        </div></div>
    </header>
    <nav id="toc">
      <nav id="TableOfContents">
<ul>
<li><a href="#intro">Intro</a>
<ul>
<li><a href="#create-the-project-master-gpg-key">Create the project master GPG key</a></li>
<li><a href="#create-a-signing-sub-key">Create a signing sub-key</a></li>
<li><a href="#prepare-keys-for-ci-cd">Prepare keys for CI/CD</a></li>
<li><a href="#take-the-master-key-offline">Take the master key offline</a></li>
<li><a href="#test-sign-with-goreleaser">Test sign with goreleaser</a></li>
</ul></li>
</ul>
</nav>
    </nav>
    <div class="post-content">
      

<h1 id="intro">Intro</h1>

<p><em>TODO: intro, rationale, link to the stackoverflow article that sparked the idea</em></p>

<h2 id="create-the-project-master-gpg-key">Create the project master GPG key</h2>

<p>This guide assumes you have already created a personal GPG key. This is referred to as an &ldquo;author key&rdquo;
in this guide and will be used to sign the project key, verifying your relationship to the project.</p>

<p>List current secret keys (<code>-K /--list-secret-keys</code>):</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ gpg --keyid-format long -K

/Users/joe/.gnupg/pubring.kbx
-----------------------------
sec   rsa4096/ADC517A11EB0B309 2016-02-09 [SC]
      Key fingerprint = CF5C 5827 E7BD 7059 7992  8EC4 ADC5 17A1 1EB0 B309
uid                 [ultimate] Joe Miller &lt;joemiller@keybase.io&gt;
ssb   rsa2048/3C7B936B8FC96571 2016-02-09 [E] [expires: 2024-02-07]
ssb   rsa2048/B0FBB6EC7A273832 2016-02-09 [SA] [expires: 2024-02-07]
ssb   rsa2048/4AE3F48180C87370 2019-07-12 [S]</code></pre></div>
<p>Generate a new master GPG key. This will be the &ldquo;project key&rdquo;:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ gpg --expert --full-generate-key

Please select what kind of key you want:
   (1) RSA and RSA (default)
   (2) DSA and Elgamal
   (3) DSA (sign only)
   (4) RSA (sign only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
   (9) ECC and ECC
  (10) ECC (sign only)
  (11) ECC (set your own capabilities)
  (13) Existing key
Your selection? 8

Possible actions for a RSA key: Sign Certify Encrypt Authenticate
Current allowed actions: Sign Certify Encrypt

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? E

Possible actions for a RSA key: Sign Certify Encrypt Authenticate
Current allowed actions: Sign Certify

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? S

Possible actions for a RSA key: Sign Certify Encrypt Authenticate
Current allowed actions: Certify

   (S) Toggle the sign capability
   (E) Toggle the encrypt capability
   (A) Toggle the authenticate capability
   (Q) Finished

Your selection? Q
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 4096
Requested keysize is 4096 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 0
Key does not expire at all
Is this correct? (y/N) y

GnuPG needs to construct a user ID to identify your key.

Real name: vault-token-helper
Email address: vault-token-helper@joemiller.me
Comment: github.com/joemiller/vault-token-helper project key
You selected this USER-ID:
    &#34;vault-token-helper (github.com/joemiller/vault-token-helper project key) &lt;vault-token-helper@joemiller.me&gt;&#34;

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? o
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.
gpg: key 37F9D1272278CD32 marked as ultimately trusted
public and secret key created and signed.

pub   rsa4096 2019-07-13 [C]
      5EF225507053ACC2728AA51C37F9D1272278CD32
uid        vault-token-helper (github.com/joemiller/vault-token-helper project key) &lt;vault-token-helper@joemiller.me&gt;</code></pre></div>
<p>We now have a new master key with only the <code>[C]</code> (certify) bit set. It is a special kind of key
that can only sign sub-keys. We will create a signing sub-key for signing the releases next and
sign it with the master key.</p>

<p>Export the keyid:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">export KEYID=5EF225507053ACC2728AA51C37F9D1272278CD32</code></pre></div>
<h2 id="create-a-signing-sub-key">Create a signing sub-key</h2>

<p>Now that we have established a new master key for the project we will create a sub-key that
will be used for signing releases. By creating a sub-key for signing we are able to keep the
master key safely offline. The sub-key can be deployed to your CI/CD pipeline. If it is compromised
it can be revoked by the master key and replaced with a new sub-key.</p>

<p>Edit the master key:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">gpg --expert --edit-key $KEYID</code></pre></div>
<p>Create a signing key by selecting <code>(4) RSA (sign only):</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">gpg&gt; addkey

Please select what kind of key you want:
   (3) DSA (sign only)
   (4) RSA (sign only)
   (5) Elgamal (encrypt only)
   (6) RSA (encrypt only)
   (7) DSA (set your own capabilities)
   (8) RSA (set your own capabilities)
  (10) ECC (sign only)
  (11) ECC (set your own capabilities)
  (12) ECC (encrypt only)
  (13) Existing key
Your selection? 4
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (2048) 4096
Requested keysize is 4096 bits
Please specify how long the key should be valid.
         0 = key does not expire
      &lt;n&gt;  = key expires in n days
      &lt;n&gt;w = key expires in n weeks
      &lt;n&gt;m = key expires in n months
      &lt;n&gt;y = key expires in n years
Key is valid for? (0) 0
Key does not expire at all
Is this correct? (y/N) y
Really create? (y/N) y
We need to generate a lot of random bytes. It is a good idea to perform
some other action (type on the keyboard, move the mouse, utilize the
disks) during the prime generation; this gives the random number
generator a better chance to gain enough entropy.

sec  rsa4096/37F9D1272278CD32
     created: 2019-07-13  expires: never       usage: C
     trust: ultimate      validity: ultimate
ssb  rsa4096/6720A9FD78AC13F5
     created: 2019-07-13  expires: never       usage: S
[ultimate] (1). vault-token-helper (github.com/joemiller/vault-token-helper project key) &lt;vault-token-helper@joemiller.me&gt;</code></pre></div>
<p>Save and exit:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">gpg&gt; save</code></pre></div>
<p>List secret keys. There are now two keys, our author key and a new project key:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ gpg --keyid-format long -K

sec   rsa4096/ADC517A11EB0B309 2016-02-09 [SC]
      Key fingerprint = CF5C 5827 E7BD 7059 7992  8EC4 ADC5 17A1 1EB0 B309
uid          [ultimate] Joe Miller &lt;joemiller@keybase.io&gt;
ssb   rsa2048/3C7B936B8FC96571 2016-02-09 [E] [expires: 2024-02-07]
ssb   rsa2048/B0FBB6EC7A273832 2016-02-09 [SA] [expires: 2024-02-07]
ssb   rsa2048/4AE3F48180C87370 2019-07-12 [S]

sec   rsa4096/37F9D1272278CD32 2019-07-13 [C]
      5EF225507053ACC2728AA51C37F9D1272278CD32
uid         [ultimate] vault-token-helper (github.com/joemiller/vault-token-helper project key) &lt;vault-token-helper@joemiller.me&gt;
ssb   rsa4096/6720A9FD78AC13F5 2019-07-13 [S]</code></pre></div>
<p>Sign the project key with your author key:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">gpg --sign-key $KEYID</code></pre></div>
<p>Publish the project key to the key server network. This allows others to easily download
the project&rsquo;s public key to verify releases:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">gpg --send-key $KEYID</code></pre></div>
<h2 id="prepare-keys-for-ci-cd">Prepare keys for CI/CD</h2>

<p>Now that we have created our project key and a sub-key for signing we will export the
sub-key and base64 encode it for use in our CI/CD system.</p>

<p>List the master and sub-key ID&rsquo;s:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ gpg --keyid-format long -K $KEYID

sec   rsa4096/37F9D1272278CD32 2019-07-13 [C]
      Key fingerprint = 5EF2 2550 7053 ACC2 728A  A51C 37F9 D127 2278 CD32
uid            [ultimate] vault-token-helper (github.com/joemiller/vault-token-helper project key) &lt;vault-token-helper@joemiller.me&gt;
ssb   rsa4096/6720A9FD78AC13F5 2019-07-13 [S]</code></pre></div>
<p>Export the sub-key ID:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">export SUBKEY=6720A9FD78AC13F5</code></pre></div>
<p>Export the sub-key - and <strong>ONLY</strong> the sub-key. The <code>!</code> is important for exporting only the sub-key:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">gpg --armor --export-secret-subkeys $SUBKEY\! &gt;vault-token-helper.signing-key.gpg</code></pre></div>
<p>Base64 encode the signing-key and copy it into your clipboard. <code>pbcopy</code> copies stdin to the clipboard on macOS:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">cat vault-token-helper.signing-key.gpg | base64 | pbcopy</code></pre></div>
<p>Create an environment variable <code>GPG_KEY</code> in your CI system using the base64 encoded copy of the signing key as the contents.</p>

<h2 id="take-the-master-key-offline">Take the master key offline</h2>

<p>This step is optional but it increases the security of the project master key. In this stage
we will delete the master key from our keychain and leave only the signing sub-key. This will
allow us to sign builds locally. You could also delete the entire master key and sub-key if you
wish.</p>

<p>Make a backup of the master key and sub-key. This should be saved in a safe offline space
such as an encrypted USB key.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">gpg --armor --export-secret-keys $KEYID  &gt;vault-token-helper.gpg</code></pre></div>
<p>Delete the master key from your keychain:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">gpg --delete-secret-keys $KEYID</code></pre></div>
<p>In the future you will need access to the master key such as to add new sub-keys, revoke
existing sub-keys, etc. To do so import the master key from the backup:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">gpg --import vault-token-helper.gpg</code></pre></div>
<h2 id="test-sign-with-goreleaser">Test sign with goreleaser</h2>

<p><em>TODO: need to do something better with this section.. maybe show circleci example.. or at least</em>
   <em>show running goreleaser config snippet and running without make file</em></p>

<p>Testing the release and sign process:</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-console" data-lang="console">$ GPG_KEY=&#34;$(cat vault-token-helper.signing-key.gpg | base64)&#34; make snapshot

$ ll dist/*checksum*

-r--r--r--  1 joe  staff   943B Jul 13 17:03 dist/vault-token-helper_SNAPSHOT-64a3f96_checksums.txt
-rw-r--r--  1 joe  staff   566B Jul 13 17:03 dist/vault-token-helper_SNAPSHOT-64a3f96_checksums.txt.sig

$ gpg --verify dist/vault-token-helper_SNAPSHOT-64a3f96_checksums.txt.sig dist/vault-token-helper_SNAPSHOT-64a3f96_checksums.txt

gpg: Signature made Sat Jul 13 17:03:05 2019 PDT
gpg:                using RSA key F2B849E45FBA0CBFA0ECC9F36720A9FD78AC13F5
gpg: Good signature from &#34;vault-token-helper (github.com/joemiller/vault-token-helper project key) &lt;vault-token-helper@joemiller.me&gt;&#34; [ultimate]
Primary key fingerprint: 5EF2 2550 7053 ACC2 728A  A51C 37F9 D127 2278 CD32
     Subkey fingerprint: F2B8 49E4 5FBA 0CBF A0EC  C9F3 6720 A9FD 78AC 13F5</code></pre></div>
    </div>
    <div class="post-footer">
      
      
    </div>
  </article>

    </main>
  </body>
</html>
